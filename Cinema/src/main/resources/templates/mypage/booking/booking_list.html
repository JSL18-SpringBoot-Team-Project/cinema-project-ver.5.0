<div th:fragment="booking_list">
  <!-- Location Bar -->
  <div class="location-bar d-flex align-items-center">
    <span class="me-2">ホーム</span>
    <i class="bi bi-chevron-right me-2"></i>
    <span>マイペーじ</span>
    <i class="bi bi-chevron-right me-2"></i>
    <span>予約履歴</span>
  </div>

  <div class="content-box">
    <h2 class="mb-4">予約履歴</h2>

    <!-- タブコンテンツ -->
    <div class="tab-content" id="myTabContent">
      <!-- 予約 -->
      <div class="tab-pane fade show active" id="booking" role="tabpanel" aria-labelledby="booking-tab">
        <div class="card mt-4">
          <div class="card-body">
            <!-- 映画タイトル検索 -->
            <div class="row mb-3">
              <div class="col-md-6">
                <form th:action="@{/booking/list}" method="get" class="d-flex">
                  <input
                          type="text"
                          class="form-control"
                          name="title"
                          placeholder="映画タイトルを入力してください"
                          th:value="${param.title}" />
                  <button type="submit" class="btn btn-primary ms-2">検索</button>
                </form>
              </div>
            </div>


            <!-- 予約履歴テーブル -->
            <h5 class="card-title mt-4">予約履歴</h5>
            <div class="table-responsive">
              <table class="table table-striped" id="bookingTable">
                <thead>
                <tr>
                  <th scope="col">予約日</th>
                  <th scope="col">映画名</th>
                  <th scope="col">上映日時</th>
                  <th scope="col">座席番号</th>
                  <th scope="col">予約金額</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="booking : ${bookingList}">
                  <td th:text="${booking.timestamp}"></td>
                  <td th:text="${booking.title}"></td>
                  <td th:text="${booking.screeningDateTime}"></td>
                  <td th:text="${booking.seats.join(', ')}"></td>
                  <td th:text="${booking.price.toLocaleString()} + '円'"></td>
                </tr>
                <tr th:if="${#lists.isEmpty(bookingList)}">
                  <td colspan="5" class="text-center">予約履歴がありません。</td>
                </tr>
                </tbody>
              </table>
            </div>

            <!-- 予約キャンセル履歴 -->
            <h5 class="card-title mt-4">キャンセル履歴</h5>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                <tr>
                  <th scope="col">キャンセル日</th>
                  <th scope="col">映画名</th>
                  <th scope="col">上映日時</th>
                  <th scope="col">キャンセル金額</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="cancel : ${cancelList}">
                  <td th:text="${cancel.cancelDateTime}"></td>
                  <td th:text="${cancel.title}"></td>
                  <td th:text="${cancel.screeningDateTime}"></td>
                  <td th:text="${cancel.price}"></td>
                </tr>
                <tr th:if="${#lists.isEmpty(cancelList)}">
                  <td colspan="4" class="text-center">キャンセル履歴がありません。</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const API_BASE_URL = '/api/bookings';

  document.addEventListener('DOMContentLoaded', () => {
    // ページロード完了時
    console.log('ページがロードされました。');
  });

  function searchBookings() {
    const movieTitle = document.getElementById('movieSearch').value.trim();

    if (!movieTitle) {
      alert('映画タイトルを入力してください。');
      return;
    }

    fetchData(`${API_BASE_URL}/search?title=${encodeURIComponent(movieTitle)}`, updateBookingTable, '予約履歴を取得中にエラーが発生しました。');
  }

  function fetchData(url, onSuccess, errorMessage) {
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error(errorMessage);
        }
        return response.json();
      })
      .then(onSuccess)
      .catch(error => {
        console.error('Error:', error);
        alert(errorMessage);
      });
  }

  function updateBookingTable(data) {
    const tbody = document.querySelector('#bookingTable tbody');
    tbody.innerHTML = ''; // 既存の内容をリセット

    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">検索結果がありません。</td></tr>';
      return;
    }

    data.forEach(item => {
      const row = `
        <tr>
          <td>${item.timestamp}</td>
          <td>${item.title}</td>
          <td>${item.screeningDateTime}</td>
          <td>${item.seats.join(', ')}</td>
          <td>${item.price.toLocaleString()}円</td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
  }

</script>
